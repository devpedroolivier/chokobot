<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Din√¢mico - Chokodel√≠cia</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-pink-50 via-white to-pink-100 min-h-screen text-gray-800">

  <div class="container mx-auto px-6 py-10">
    <!-- Cabe√ßalho -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-pink-700 flex items-center gap-2">
        üç∞ Painel Din√¢mico
        <span class="text-gray-400 text-sm font-normal">Chokodel√≠cia</span>
      </h1>
      <div class="flex items-center gap-4">
        <a href="/painel/encomendas/exportar" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg text-sm transition">
          üìÑ Exportar TXT
        </a>
      </div>
    </div>

    <!-- Indicadores -->
    <div class="grid grid-cols-3 gap-4 mb-10 text-center">
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="text-sm text-gray-500">Total de Pedidos</h2>
        <p id="totalPedidos" class="text-2xl font-bold text-pink-600">{{ encomendas|length }}</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="text-sm text-gray-500">Pendentes</h2>
        <p id="totalPendentes" class="text-2xl font-bold text-yellow-600">
          {{ encomendas|selectattr('status', 'equalto', 'pendente')|list|length }}
        </p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="text-sm text-gray-500">Entregues</h2>
        <p id="totalEntregues" class="text-2xl font-bold text-green-600">
          {{ encomendas|selectattr('status', 'equalto', 'entregue')|list|length }}
        </p>
      </div>
    </div>

    <!-- Cards de Encomendas -->
    <div id="gridEncomendas" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for e in encomendas %}
      <div class="bg-white rounded-2xl shadow p-5 border-l-4 transition
                  {% if e.status == 'pendente' %} border-yellow-400 hover:shadow-yellow-200
                  {% elif e.status == 'em preparo' %} border-blue-400 hover:shadow-blue-200
                  {% elif e.status == 'entregue' %} border-green-400 hover:shadow-green-200
                  {% else %} border-gray-300 {% endif %}"
          data-status="{{ e.status or 'pendente' }}">

        <div class="flex justify-between items-start mb-2">
          <h3 class="font-bold text-pink-700">{{ e.cliente_nome }}</h3>
          <span class="px-2 py-1 rounded text-xs
            {% if e.status == 'pendente' %} bg-yellow-100 text-yellow-800
            {% elif e.status == 'em preparo' %} bg-blue-100 text-blue-800
            {% elif e.status == 'entregue' %} bg-green-100 text-green-800
            {% else %} bg-gray-100 text-gray-700 {% endif %}">
            {{ e.status or 'pendente' }}
          </span>
        </div>

        <p class="text-sm text-gray-700">
          <strong>Categoria:</strong>
          <a href="/painel/encomendas/{{ e.id }}"
            class="text-pink-600 hover:underline hover:text-pink-800 transition">
            {{ e.categoria or 'Ver detalhes' }}
          </a>
        </p>
        <p class="text-sm text-gray-700"><strong>Data:</strong> {{ e.data_entrega or '-' }}</p>
        <p class="text-sm text-gray-700"><strong>Hor√°rio:</strong> {{ e.horario or '-' }}</p>
        <p class="text-sm text-gray-700"><strong>Valor:</strong> R$ {{ e.valor_total or '0,00' }}</p>

        <div class="mt-4 text-right">
          {% if e.status != 'entregue' %}
          <button
            class="btn-finalizar bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition"
            data-id="{{ e.id }}">
            ‚úÖ Finalizar
          </button>
          {% else %}
          <span class="text-gray-400 text-xs italic">Conclu√≠do</span>
          {% endif %}
        </div>
      </div>
      {% else %}
      <p class="col-span-3 text-center text-gray-500">Nenhuma encomenda encontrada.</p>
      {% endfor %}
    </div>
  </div>

  <script>
    // Atualiza status sem recarregar
    document.querySelectorAll(".btn-finalizar").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        btn.disabled = true;
        btn.textContent = "‚è≥ Atualizando...";

        try {
          const response = await fetch(`/painel/encomendas/${id}/status`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "status=entregue"
          });

          if (response.ok) {
            const card = btn.closest("div[data-status]");
            card.dataset.status = "entregue";

            // Atualiza visual
            const statusSpan = card.querySelector("span");
            statusSpan.textContent = "entregue";
            statusSpan.className = "px-2 py-1 rounded text-xs bg-green-100 text-green-800";

            btn.outerHTML = `<span class="text-gray-400 text-xs italic">Conclu√≠do</span>`;
            atualizarContadores();
          } else {
            btn.textContent = "‚ùå Erro";
            btn.disabled = false;
          }
        } catch (err) {
          console.error("Erro:", err);
          btn.textContent = "‚ö†Ô∏è Falha";
          btn.disabled = false;
        }
      });
    });

    // Atualiza contadores no topo
    function atualizarContadores() {
      const cards = document.querySelectorAll("#gridEncomendas > div[data-status]");
      let total = 0, pendentes = 0, entregues = 0;

      cards.forEach(card => {
        const status = card.dataset.status;
        if (!status) return;
        total++;
        if (status === "pendente") pendentes++;
        if (status === "entregue") entregues++;
      });

      document.getElementById("totalPedidos").textContent = total;
      document.getElementById("totalPendentes").textContent = pendentes;
      document.getElementById("totalEntregues").textContent = entregues;
    }
  </script>

</body>
</html>
